<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Dashboard</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. QRCode.js for Share Page -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- 3. Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 4. Chart.js for Dashboard (optional, but good for reports) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* Hide scrollbars for a cleaner look */
        ::-webkit-scrollbar { display: none; }
        body { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Main content transitions */
        .page-content {
            transition: opacity 0.2s ease-in-out;
        }
        
        /* Active/Inactive Sidebar Link Styles */
        .sidebar-link {
            @apply flex items-center p-3 my-1 rounded-lg text-gray-200 hover:bg-green-600 transition-colors duration-200;
        }
        .sidebar-link-active {
            @apply bg-green-700 text-white font-semibold;
        }
        
        /* Custom styles for POS */
        .pos-item-selected {
            @apply ring-2 ring-green-500 border-transparent;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- =========== LOADING SPINNER =========== -->
    <div id="loading-spinner" class="fixed inset-0 z-50 flex h-screen w-full flex-col items-center justify-center bg-white">
        <div class="h-16 w-16 animate-spin rounded-full border-8 border-t-green-600 border-gray-200"></div>
        <p id="loading-text" class="mt-4 text-lg font-medium text-gray-700">Loading Dashboard...</p>
    </div>

    <!-- Main App Wrapper -->
    <div id="app-view" class="hidden min-h-screen lg:flex">
        
        <!-- Sidebar Navigation -->
        <nav class="w-64 flex-shrink-0 bg-gray-800 text-white">
            <div class="flex h-20 items-center justify-center bg-gray-900 shadow-md">
                <h1 class="text-2xl font-bold text-white">Ommen's Fashion</h1>
            </div>
            <div class="p-4">
                <a href="#dashboard" class="sidebar-link sidebar-link-active">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1h-2a1 1 0 01-1-1v-4z"></path></svg>
                    Dashboard
                </a>
                <a href="#pos" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Point of Sale (POS)
                </a>
                <a href="#sales-history" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Sales History
                </a>
                <a href="#reports" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0l6 0m-6 0v-6a2 2 0 012-2h2a2 2 0 012 2v6m0 0v-6a2 2 0 00-2-2h-2a2 2 0 00-2 2v6m0 0l6 0m-6 0l6 0"></path></svg>
                    Reports
                </a>
                
                <p class="mt-4 mb-1 px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Manage</p>
                <a href="#inventory" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                    Inventory
                </a>
                <a href="#add-inventory" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Add Inventory
                </a>
                <a href="#customers" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 016-6h6v1a6 6 0 01-6 6v-1zm6-3a3 3 0 100-6 3 3 0 000 6z"></path></svg>
                    Customers
                </a>
                <a href="#add-customer" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                    Add Customer
                </a>
                <a href="#expenses" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-4 4h4m2 0h-2m2 0h2M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    Expenses
                </a>
                
                <p class="mt-4 mb-1 px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Settings</p>
                <a href="#share" class="sidebar-link">
                    <svg class="h-6 w-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
                    Share Page
                </a>
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col h-screen">
            <!-- Top Bar -->
            <header class="h-20 flex-shrink-0 bg-white shadow-md flex items-center justify-end px-8">
                <div class="text-right">
                    <p id="user-id-display" class="text-xs text-gray-500"></p>
                    <button id="logout-btn" class="text-sm font-medium text-green-600 hover:text-green-800">Logout</button>
                </div>
            </header>

            <!-- Page Content -->
            <main id="main-content" class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                
                <!-- =========== PAGE: DASHBOARD (Cost/Income) =========== -->
                <div id="dashboard-page" class="page-content">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
                    <div id="dashboard-loading" class="text-center text-gray-500">Loading stats...</div>
                    <div id="dashboard-stats" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white rounded-lg shadow-lg p-6 flex items-center">
                            <div class="bg-green-100 rounded-full p-3">
                                <svg class="h-8 w-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2-1.343-2-3-2zM0 14s3-2 6-2 6 2 6 2v4H0v-4zm12 0s3-2 6-2 6 2 6 2v4h-6v-4zm0 0v4h6m-6-4H6"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Total Revenue</p>
                                <p id="stat-revenue" class="text-2xl font-bold text-gray-900">₹0.00</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6 flex items-center">
                            <div class="bg-blue-100 rounded-full p-3">
                                <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-4 4h4m2 0h-2m2 0h2M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Total Expenses</p>
                                <p id="stat-expenses" class="text-2xl font-bold text-gray-900">₹0.00</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6 flex items-center">
                            <div class="bg-yellow-100 rounded-full p-3">
                                <svg class="h-8 w-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Total Profit</p>
                                <p id="stat-profit" class="text-2xl font-bold text-gray-900">₹0.00</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow-lg p-6 flex items-center">
                            <div class="bg-purple-100 rounded-full p-3">
                                <svg class="h-8 w-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500">Net Income</p>
                                <p id="stat-net-income" class="text-2xl font-bold text-gray-900">₹0.00</p>
                            </div>
                        </div>
                    </div>
                    <!-- Chart placeholder -->
                    <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Sales vs Expenses (Last 30 Days)</h2>
                        <canvas id="main-chart" class="w-full"></canvas>
                    </div>
                </div>

                <!-- =========== PAGE: POINT OF SALE (POS) =========== -->
                <div id="pos-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Point of Sale (POS)</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Product Selection -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-lg shadow-lg p-6">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Select Products to Sell</h2>
                                <input type="text" id="pos-search" placeholder="Search products..." class="w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 mb-4">
                                <div id="pos-inventory-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-96 overflow-y-auto p-2 bg-gray-50 rounded-lg">
                                    <!-- Products load here -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right: Cart -->
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-lg shadow-lg p-6 sticky top-6">
                                <h2 class="text-xl font-semibold text-gray-800 mb-4">Current Sale</h2>
                                <div id="pos-cart" class="space-y-3 mb-4 min-h-[100px] max-h-60 overflow-y-auto">
                                    <p id="pos-cart-empty" class="text-gray-500 text-center">No items in cart.</p>
                                </div>
                                <div class="border-t pt-4 space-y-2">
                                    <div class="flex justify-between items-center text-lg font-semibold">
                                        <span>Total:</span>
                                        <span id="pos-cart-total" class="text-green-600">₹0.00</span>
                                    </div>
                                    <div class="form-group">
                                        <label for="pos-customer" class="text-sm font-medium text-gray-700">Customer (Optional)</label>
                                        <input type="text" id="pos-customer" placeholder="Walk-in Customer" class="w-full mt-1 rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500">
                                    </div>
                                    <button id="record-sale-btn" class="w-full transform rounded-lg bg-green-600 px-6 py-3 font-semibold text-white shadow-md transition hover:-translate-y-0.5 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 disabled:opacity-50" disabled>
                                        Record Sale
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- =========== PAGE: SALES HISTORY =========== -->
                <div id="sales-history-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Sales History</h1>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit</th>
                                </tr>
                            </thead>
                            <tbody id="sales-history-table" class="divide-y divide-gray-200">
                                <!-- Sales load here -->
                            </tbody>
                        </table>
                        <div id="sales-history-loading" class="p-4 text-center text-gray-500">Loading sales history...</div>
                    </div>
                </div>

                <!-- =========== PAGE: REPORTS (Highest Selling) =========== -->
                <div id="reports-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Reports</h1>
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h2 class="text-xl font-semibold text-gray-800 mb-4">Top Selling Products</h2>
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                                    <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units Sold</th>
                                </tr>
                            </thead>
                            <tbody id="top-selling-table" class="divide-y divide-gray-200">
                                <!-- Products load here -->
                            </tbody>
                        </table>
                        <div id="reports-loading" class="p-4 text-center text-gray-500">Calculating reports...</div>
                    </div>
                </div>
                
                <!-- =========== PAGE: INVENTORY (List) =========== -->
                <div id="inventory-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Inventory</h1>
                    <div id="inventory-list-loading" class="text-center text-gray-500">Loading inventory...</div>
                    <div id="inventory-list-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Inventory cards load here -->
                    </div>
                </div>
                
                <!-- =========== PAGE: ADD INVENTORY (Form) =========== -->
                <div id="add-inventory-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Add New Inventory</h1>
                    <form id="add-inventory-form" class="max-w-3xl mx-auto rounded-lg bg-white p-6 shadow-lg">
                        <div class="space-y-6">
                            <div>
                                <label for="jersey-name" class="block text-sm font-medium text-gray-700">Jersey Name</label>
                                <input type="text" id="jersey-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="jersey-size" class="block text-sm font-medium text-gray-700">Size</label>
                                    <select id="jersey-size" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                        <option>S</option>
                                        <option>M</option>
                                        <option>L</option>
                                        <option>XL</option>
                                        <option>XXL</option>
                                        <option>Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="jersey-stock" class="block text-sm font-medium text-gray-700">Stock Quantity</label>
                                    <input type="number" id="jersey-stock" required min="0" value="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="jersey-cost" class="block text-sm font-medium text-gray-700">Your Cost (₹)</label>
                                    <input type="number" id="jersey-cost" min="0" step="1" placeholder="e.g., 800" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="jersey-price" class="block text-sm font-medium text-gray-700">Selling Price (₹)</label>
                                    <input type="number" id="jersey-price" min="0" step="1" placeholder="e.g., 1499" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="jersey-image" class="block text-sm font-medium text-gray-700">Jersey Image</label>
                                <input type="file" id="jersey-image" accept="image/png, image/jpeg, image/webp" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:cursor-pointer file:rounded-lg file:border-0 file:bg-green-50 file:px-4 file:py-2 file:text-sm file:font-semibold file:text-green-700 hover:file:bg-green-100"/>
                            </div>
                        </div>
                        <div class="mt-8 text-right">
                            <button type="submit" id="add-stock-btn" class="transform rounded-lg bg-green-600 px-6 py-2.5 font-semibold text-white shadow-md transition hover:-translate-y-0.5 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Add to Stock
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- =========== PAGE: CUSTOMERS (List) =========== -->
                <div id="customers-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Customers</h1>
                    <div id="customers-loading" class="text-center text-gray-500">Loading customers...</div>
                    <div id="customer-list-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- Customer cards load here -->
                    </div>
                </div>
                
                <!-- =========== PAGE: ADD CUSTOMER (Form) =========== -->
                <div id="add-customer-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Add New Customer</h1>
                    <form id="add-customer-form" class="max-w-3xl mx-auto rounded-lg bg-white p-6 shadow-lg">
                        <div class="space-y-6">
                            <div>
                                <label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                                <input type="text" id="customer-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="customer-contact" class="block text-sm font-medium text-gray-700">Contact (Phone/Email)</label>
                                <input type="text" id="customer-contact" placeholder="e.g., 9876543210" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                            </div>
                            <div>
                                <label for="customer-category" class="block text-sm font-medium text-gray-700">Category</label>
                                <select id="customer-category" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                    <option value="regular">Regular</option>
                                    <option value="mid">Middle Class</option>
                                    <option value="high">High Class</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-8 text-right">
                            <button type="submit" class="transform rounded-lg bg-green-600 px-6 py-2.5 font-semibold text-white shadow-md transition hover:-translate-y-0.5 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Add Customer
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- =========== PAGE: EXPENSES (List & Form) =========== -->
                <div id="expenses-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Expenses</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Add Expense Form -->
                        <div class="lg:col-span-1">
                            <form id="add-expense-form" class="rounded-lg bg-white p-6 shadow-lg">
                                <h2 class="mb-6 border-b border-gray-200 pb-3 text-2xl font-semibold text-gray-800">Add New Expense</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label for="expense-desc" class="block text-sm font-medium text-gray-700">Description</label>
                                        <input type="text" id="expense-desc" required placeholder="e.g., Shop Rent" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                    </div>
                                    <div>
                                        <label for="expense-amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                                        <input type="number" id="expense-amount" required min="0" placeholder="e.g., 5000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                    </div>
                                    <div class="text-right pt-2">
                                        <button type="submit" class="transform rounded-lg bg-green-600 px-6 py-2.5 font-semibold text-white shadow-md transition hover:-translate-y-0.5 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                            Add Expense
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <!-- Right: Expenses List -->
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                            <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                            <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="expenses-table" class="divide-y divide-gray-200">
                                        <!-- Expenses load here -->
                                    </tbody>
                                </table>
                                <div id="expenses-loading" class="p-4 text-center text-gray-500">Loading expenses...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- =========== PAGE: SHARE (QR Codes) =========== -->
                <div id="share-page" class="page-content hidden">
                    <h1 class="text-3xl font-bold text-gray-800 mb-6">Share Page</h1>
                    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                        <div class="rounded-lg bg-white p-6 text-center shadow-lg">
                            <h2 class="mb-4 text-2xl font-semibold text-green-800">Your Social Links</h2>
                            <p class="mb-4 text-gray-600">Scan for WhatsApp, Call, & Insta.</p>
                            <div id="qrcode-container" class="mx-auto flex h-64 w-64 items-center justify-center rounded-lg border border-gray-200 bg-gray-50 text-gray-500">
                                Generating...
                            </div>
                            <div class="mt-4 flex items-center justify-center space-x-3">
                                <button id="print-qr-btn" class="transform rounded-lg bg-blue-600 px-5 py-2 text-sm font-medium text-white shadow-md transition hover:-translate-y-0.5 hover:bg-blue-700">
                                    Print QR
                                </button>
                                <button id="copy-link-btn" class="rounded-lg bg-gray-100 px-5 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200">
                                    Copy Link
                                </button>
                            </div>
                            <div class="mt-4">
                                <p class="text-sm font-medium text-gray-700">Your unique social link:</p>
                                <input id="shareable-link" type="text" readonly class="w-full rounded-md border-none bg-gray-100 p-2 text-center text-sm text-gray-600" value="Loading..." />
                            </div>
                        </div>
                        
                        <div class="rounded-lg bg-white p-6 text-center shadow-lg">
                            <h2 class="mb-4 text-2xl font-semibold text-green-800">Your Public Collection</h2>
                            <p class="mb-4 text-gray-600">Link for customers to browse your catalog.</p>
                            <div id="collection-qrcode-container" class="mx-auto flex h-64 w-64 items-center justify-center rounded-lg border border-gray-200 bg-gray-50 text-gray-500">
                                Generating...
                            </div>
                            <div class="mt-4 flex items-center justify-center space-x-3">
                                <button id="print-collection-qr-btn" class="transform rounded-lg bg-blue-600 px-5 py-2 text-sm font-medium text-white shadow-md transition hover:-translate-y-0.5 hover:bg-blue-700">
                                    Print QR
                                </button>
                                <button id="copy-collection-link-btn" class="rounded-lg bg-gray-100 px-5 py-2 text-sm font-medium text-gray-800 hover:bg-gray-200">
                                    Copy Link
                                </button>
                            </div>
                            <div class="mt-4">
                                <p class="text-sm font-medium text-gray-700">Your public collection link:</p>
                                <input id="collection-link" type="text" readonly class="w-full rounded-md border-none bg-gray-100 p-2 text-center text-sm text-gray-600" value="https://vinodbhaiya.onrender.com/collection.html" />
                            </div>
                        </div>
                        
                        <div class="rounded-lg bg-white p-6 shadow-lg lg:col-span-1">
                            <h2 class="mb-6 border-b border-gray-200 pb-3 text-2xl font-semibold text-green-800">Configure Links</h2>
                            <form id="share-settings-form" class="space-y-6">
                                <div>
                                    <label for="whatsapp-url" class="block text-sm font-medium text-gray-700">WhatsApp Link</label>
                                    <input type="url" id="whatsapp-url" placeholder="https://wa.me/91..." required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="phone-number" class="block text-sm font-medium text-gray-700">Phone Number (for Calls)</label>
                                    <input type="text" id="phone-number" placeholder="10-digit number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                </div>
                                <div>
                                    <label for="instagram-url" class="block text-sm font-medium text-gray-700">Instagram Link</label>
                                    <input type="url" id="instagram-url" placeholder="https://instagram.com/..." required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                </div>
                                <div class="text-right">
                                    <button type="submit" class="transform rounded-lg bg-green-500 px-6 py-2.5 font-semibold text-white shadow-md transition hover:-translate-y-0.5 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                        Save Links
                                    </button>
                                </div>
                                <p id="save-links-success" class="hidden text-center font-medium text-green-600">Links saved successfully!</p>
                            </form>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <!-- Mobile Fallback -->
    <div id="mobile-fallback" class="lg:hidden flex h-screen w-full flex-col items-center justify-center bg-gray-900 p-6 text-center text-white">
        <svg class="h-20 w-20 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
        <h2 class="mt-6 text-3xl font-bold">Dashboard Best on Desktop</h2>
        <p class="mt-4 text-lg text-gray-300">This business management dashboard is designed for a larger screen. Please log in on a desktop, laptop, or tablet for the best experience.</p>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-10 right-10 z-50 hidden transform rounded-lg bg-gray-900 px-5 py-3 text-white shadow-lg transition-all">
        <span id="toast-message"></span>
    </div>

    <script type="module">
        // --- 1. SUPABASE & APP STATE ---
        const SUPABASE_URL = 'https://axjetoaqrybsfohqhtll.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4amV0b2Fxcnlic2ZvaHFodGxsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxNzUwMjksImV4cCI6MjA3ODc1MTAyOX0.Q5C5LAANqBn2rD-VJtG-CxUQ9aupHzgt1OSMNClI8x4';
        const IMAGE_BUCKET = 'jersey-images';

        let supabase;
        let user = null;
        let mainChart = null;
        
        // This holds the master list of inventory for the POS
        let posInventoryCache = [];
        // This holds the items for the current sale
        let posCart = [];

        const { createClient } = window.supabase;
        supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- DOM Elements ---
        const loadingSpinner = document.getElementById('loading-spinner');
        const loadingText = document.getElementById('loading-text');
        const appView = document.getElementById('app-view');
        const mobileFallback = document.getElementById('mobile-fallback');
        const userIdDisplay = document.getElementById('user-id-display');
        const allPages = document.querySelectorAll('.page-content');
        const allSidebarLinks = document.querySelectorAll('.sidebar-link');
        
        // --- 2. AUTHENTICATION & ROUTING ---

        function handleRouting() {
            // This dashboard is not usable on mobile
            if (window.innerWidth < 1024) {
                appView.style.display = 'none';
                mobileFallback.style.display = 'flex';
                loadingSpinner.style.display = 'none';
                return;
            }
            appView.style.display = 'flex';
            mobileFallback.style.display = 'none';

            // No hash, check session
            if (!window.location.hash) {
                loadingSpinner.style.display = 'flex';
                loadingText.textContent = 'Connecting to session...';
                checkUserSession();
            } else {
                // We have a hash, show the requested page
                showPage(window.location.hash.replace('#', ''));
            }
        }

        async function checkUserSession() {
            const { data, error } = await supabase.auth.getSession();
            if (error) {
                console.error("Error getting session:", error);
                loadingText.textContent = "Error connecting. Please refresh.";
                return;
            }
            if (data.session) {
                user = data.session.user;
                await loadMainApp();
            } else {
                loadingText.textContent = 'Creating secure session...';
                await signInAnonymously();
            }
        }

        async function signInAnonymously() {
            const { data, error } = await supabase.auth.signInAnonymously();
            if (error) {
                console.error("Error signing in:", error);
                loadingText.textContent = "Error creating session. Please refresh.";
            } else {
                user = data.user;
                await loadMainApp();
            }
        }
        
        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error("Error signing out:", error);
                showToast("Error signing out.", 'error');
            } else {
                user = null;
                window.location.hash = '';
                window.location.reload();
            }
        }
        
        async function loadMainApp() {
            if (!user) {
                console.error("No user found. Cannot load app.");
                loadingText.textContent = "Authentication failed.";
                return;
            }
            
            userIdDisplay.textContent = `User ID: ${user.id.substring(0, 8)}...`;
            
            attachMainAppListeners();
            
            // Set default route to dashboard
            window.location.hash = 'dashboard';
            await showPage('dashboard');
            
            loadingSpinner.style.display = 'none';
        }
        
        // --- 3. MAIN APP: PAGE NAVIGATION ---

        async function showPage(pageName) {
            if (!user && pageName !== 'share') {
                // If user is somehow lost, re-auth
                checkUserSession();
                return;
            }
            
            allPages.forEach(page => {
                page.style.display = page.id === `${pageName}-page` ? 'block' : 'none';
            });
            
            allSidebarLinks.forEach(link => {
                link.classList.toggle('sidebar-link-active', link.href.endsWith(`#${pageName}`));
            });
            
            // Load data for the specific page
            switch(pageName) {
                case 'dashboard':
                    await loadDashboardStats();
                    break;
                case 'pos':
                    await loadPosInventory();
                    break;
                case 'sales-history':
                    await loadSalesHistory();
                    break;
                case 'reports':
                    await loadReports();
                    break;
                case 'inventory':
                    await loadInventoryList();
                    break;
                case 'customers':
                    await loadCustomerList();
                    break;
                case 'expenses':
                    await loadExpenses();
                    break;
                case 'share':
                    await loadShareSettings();
                    break;
                // 'add-inventory' and 'add-customer' are just forms, no data load needed
            }
        }
        
        // --- 4. MAIN APP: EVENT LISTENERS ---
        
        function attachMainAppListeners() {
            window.addEventListener('hashchange', () => handleRouting());
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Form Submissions
            document.getElementById('add-inventory-form').addEventListener('submit', handleAddInventory);
            document.getElementById('add-customer-form').addEventListener('submit', handleAddCustomer);
            document.getElementById('add-expense-form').addEventListener('submit', handleAddExpense);
            document.getElementById('share-settings-form').addEventListener('submit', handleSaveShareLinks);
            document.getElementById('record-sale-btn').addEventListener('click', handleRecordSale);

            // POS Search
            document.getElementById('pos-search').addEventListener('input', (e) => renderPosInventory(e.target.value));

            // Share Page Buttons
            document.getElementById('copy-link-btn').addEventListener('click', () => copyShareLink('shareable-link'));
            document.getElementById('print-qr-btn').addEventListener('click', () => handlePrintQR('qrcode-container', 'Social Links'));
            document.getElementById('copy-collection-link-btn').addEventListener('click', () => copyShareLink('collection-link'));
            document.getElementById('print-collection-qr-btn').addEventListener('click', () => handlePrintQR('collection-qrcode-container', 'Public Collection'));
        }

        // --- 5. PAGE: DASHBOARD (STATS & CHART) ---

        async function loadDashboardStats() {
            document.getElementById('dashboard-stats').style.display = 'none';
            document.getElementById('dashboard-loading').style.display = 'block';

            const { data: sales, error: salesError } = await supabase
                .from('sales')
                .select('total_amount, total_profit, created_at')
                .eq('user_id', user.id);
                
            const { data: expenses, error: expensesError } = await supabase
                .from('expenses')
                .select('amount, created_at')
                .eq('user_id', user.id);

            if (salesError || expensesError) {
                console.error("Error fetching stats:", salesError || expensesError);
                showToast('Error loading dashboard stats.', 'error');
                return;
            }

            const totalRevenue = sales.reduce((acc, sale) => acc + parseFloat(sale.total_amount), 0);
            const totalProfit = sales.reduce((acc, sale) => acc + parseFloat(sale.total_profit), 0);
            const totalExpenses = expenses.reduce((acc, exp) => acc + parseFloat(exp.amount), 0);
            const netIncome = totalProfit - totalExpenses;

            document.getElementById('stat-revenue').textContent = `₹${totalRevenue.toFixed(2)}`;
            document.getElementById('stat-expenses').textContent = `₹${totalExpenses.toFixed(2)}`;
            document.getElementById('stat-profit').textContent = `₹${totalProfit.toFixed(2)}`;
            document.getElementById('stat-net-income').textContent = `₹${netIncome.toFixed(2)}`;

            document.getElementById('dashboard-stats').style.display = 'grid';
            document.getElementById('dashboard-loading').style.display = 'none';
            
            // --- Chart.js Logic ---
            const chartCtx = document.getElementById('main-chart').getContext('2d');
            const { labels, salesData, expensesData } = processChartData(sales, expenses);

            if (mainChart) {
                mainChart.destroy();
            }
            mainChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Sales Revenue',
                            data: salesData,
                            borderColor: 'rgb(22, 163, 74)',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Expenses',
                            data: expensesData,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => `₹${value}`
                            }
                        }
                    }
                }
            });
        }
        
        function processChartData(sales, expenses, days = 30) {
            const labels = [];
            const salesMap = new Map();
            const expensesMap = new Map();
            const today = new Date();

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateString = date.toISOString().split('T')[0];
                labels.push(date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }));
                salesMap.set(dateString, 0);
                expensesMap.set(dateString, 0);
            }

            sales.forEach(sale => {
                const dateString = new Date(sale.created_at).toISOString().split('T')[0];
                if (salesMap.has(dateString)) {
                    salesMap.set(dateString, salesMap.get(dateString) + parseFloat(sale.total_amount));
                }
            });

            expenses.forEach(expense => {
                const dateString = new Date(expense.created_at).toISOString().split('T')[0];
                if (expensesMap.has(dateString)) {
                    expensesMap.set(dateString, expensesMap.get(dateString) + parseFloat(expense.amount));
                }
            });

            return {
                labels,
                salesData: Array.from(salesMap.values()),
                expensesData: Array.from(expensesMap.values())
            };
        }

        // --- 6. PAGE: POINT OF SALE (POS) ---
        
        async function loadPosInventory() {
            // Load from cache if available
            if (posInventoryCache.length > 0) {
                renderPosInventory();
                return;
            }
            
            // Fetch all inventory
            const { data, error } = await supabase
                .from('inventory')
                .select('id, name, size, stock, price, cost')
                .eq('user_id', user.id);
            
            if (error) {
                showToast('Error loading inventory for POS.', 'error');
                return;
            }
            posInventoryCache = data;
            renderPosInventory();
        }
        
        function renderPosInventory(filter = '') {
            const listEl = document.getElementById('pos-inventory-list');
            listEl.innerHTML = '';
            
            const lowerFilter = filter.toLowerCase();
            const filtered = posInventoryCache.filter(item => 
                item.name.toLowerCase().includes(lowerFilter) && item.stock > 0
            );
            
            if (filtered.length === 0) {
                listEl.innerHTML = `<p class="col-span-full text-gray-500 text-center">No products found${filter ? ' matching "' + filter + '"' : ' or all are out of stock'}.</p>`;
                return;
            }
            
            filtered.forEach(item => {
                const isSelected = posCart.find(cartItem => cartItem.id === item.id);
                const itemEl = document.createElement('div');
                itemEl.className = `p-3 bg-white rounded-lg border shadow-sm cursor-pointer ${isSelected ? 'pos-item-selected' : ''}`;
                itemEl.innerHTML = `
                    <p class="font-semibold text-gray-800">${item.name}</p>
                    <p class="text-sm text-gray-500">${item.size}</p>
                    <p class="text-sm font-medium text-green-600">₹${item.price}</p>
                    <p class="text-xs text-gray-400">Stock: ${item.stock}</p>
                `;
                itemEl.addEventListener('click', () => togglePosCart(item));
                listEl.appendChild(itemEl);
            });
        }
        
        function togglePosCart(item) {
            const cartIndex = posCart.findIndex(cartItem => cartItem.id === item.id);
            
            if (cartIndex > -1) {
                // Remove from cart
                posCart.splice(cartIndex, 1);
            } else {
                // Add to cart, with quantity 1
                if(item.stock > 0) {
                    posCart.push({ ...item, quantity: 1 });
                } else {
                    showToast('This item is out of stock.', 'error');
                }
            }
            renderPosInventory(document.getElementById('pos-search').value);
            renderPosCart();
        }
        
        function renderPosCart() {
            const cartEl = document.getElementById('pos-cart');
            const emptyMsg = document.getElementById('pos-cart-empty');
            const totalEl = document.getElementById('pos-cart-total');
            const recordBtn = document.getElementById('record-sale-btn');
            
            cartEl.innerHTML = '';
            
            if (posCart.length === 0) {
                emptyMsg.style.display = 'block';
                totalEl.textContent = '₹0.00';
                recordBtn.disabled = true;
                return;
            }
            
            emptyMsg.style.display = 'none';
            let totalAmount = 0;
            
            posCart.forEach(item => {
                const itemAmount = parseFloat(item.price) * item.quantity;
                totalAmount += itemAmount;
                
                const cartItemEl = document.createElement('div');
                cartItemEl.className = 'flex items-center justify-between py-2 border-b';
                cartItemEl.innerHTML = `
                    <div class="flex-1">
                        <p class="font-medium text-gray-800">${item.name} (${item.size})</p>
                        <p class="text-sm text-gray-500">₹${item.price} x ${item.quantity}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="number" min="1" max="${item.stock}" value="${item.quantity}" data-id="${item.id}" class="pos-quantity-input w-16 rounded-md border-gray-300 text-center shadow-sm">
                        <button data-id="${item.id}" class="pos-remove-item rounded-full p-1 text-red-500 hover:bg-red-100">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                `;
                cartEl.appendChild(cartItemEl);
            });
            
            totalEl.textContent = `₹${totalAmount.toFixed(2)}`;
            recordBtn.disabled = false;
            
            // Attach listeners for quantity change and remove
            document.querySelectorAll('.pos-quantity-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    let newQty = parseInt(e.target.value);
                    const item = posCart.find(cartItem => cartItem.id === id);
                    if (newQty > item.stock) {
                        newQty = item.stock;
                        showToast(`Only ${item.stock} in stock.`, 'error');
                    }
                    if (newQty < 1) newQty = 1;
                    item.quantity = newQty;
                    renderPosCart();
                });
            });
            
            document.querySelectorAll('.pos-remove-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    posCart = posCart.filter(item => item.id !== id);
                    renderPosInventory(document.getElementById('pos-search').value);
                    renderPosCart();
                });
            });
        }
        
        async function handleRecordSale() {
            const recordBtn = document.getElementById('record-sale-btn');
            recordBtn.disabled = true;
            recordBtn.textContent = 'Processing...';
            
            let totalAmount = 0;
            let totalCost = 0;
            
            posCart.forEach(item => {
                totalAmount += parseFloat(item.price) * item.quantity;
                totalCost += (parseFloat(item.cost) || 0) * item.quantity;
            });
            
            const totalProfit = totalAmount - totalCost;
            const customerName = document.getElementById('pos-customer').value || 'Walk-in Customer';
            
            try {
                // 1. Create the main Sale record
                const { data: sale, error: saleError } = await supabase
                    .from('sales')
                    .insert({
                        user_id: user.id,
                        customer_name: customerName,
                        total_amount: totalAmount,
                        total_cost: totalCost,
                        total_profit: totalProfit
                    })
                    .select()
                    .single();
                
                if (saleError) throw saleError;
                
                // 2. Create the Sales Items records
                const saleItems = posCart.map(item => ({
                    sale_id: sale.id,
                    inventory_id: item.id,
                    user_id: user.id,
                    quantity: item.quantity,
                    sold_price: item.price,
                    sold_cost: item.cost,
                    item_name: `${item.name} (${item.size})`
                }));
                
                const { error: itemsError } = await supabase.from('sales_items').insert(saleItems);
                if (itemsError) throw itemsError;
                
                // 3. Update stock for each item
                const stockUpdates = posCart.map(item => {
                    const newStock = item.stock - item.quantity;
                    return supabase
                        .from('inventory')
                        .update({ stock: newStock })
                        .eq('id', item.id);
                });
                
                await Promise.all(stockUpdates);
                
                // 4. Success: Clear cart and refresh
                showToast('Sale recorded successfully!', 'success');
                posCart = [];
                posInventoryCache = []; // Force refresh of inventory cache
                document.getElementById('pos-customer').value = '';
                renderPosCart();
                await loadPosInventory();
                
            } catch (error) {
                console.error("Error recording sale:", error);
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                recordBtn.disabled = false;
                recordBtn.textContent = 'Record Sale';
            }
        }
        
        // --- 7. PAGE: SALES HISTORY ---
        
        async function loadSalesHistory() {
            const tableBody = document.getElementById('sales-history-table');
            const loadingMsg = document.getElementById('sales-history-loading');
            loadingMsg.style.display = 'table-row';
            tableBody.innerHTML = '';
            
            const { data, error } = await supabase
                .from('sales')
                .select('*, sales_items(quantity, item_name)')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });
            
            if (error) {
                showToast('Error loading sales history.', 'error');
                return;
            }
            
            loadingMsg.style.display = 'none';
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-gray-500">No sales recorded yet.</td></tr>`;
                return;
            }
            
            data.forEach(sale => {
                const date = new Date(sale.created_at).toLocaleDateString('en-IN');
                const itemsCount = sale.sales_items.reduce((acc, item) => acc + item.quantity, 0);
                const firstItem = sale.sales_items[0]?.item_name || 'N/A';
                const itemsDesc = itemsCount > 1 ? `${firstItem} + ${itemsCount - 1} more` : firstItem;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                    <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">${sale.customer_name}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-500">${itemsDesc}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-900">₹${sale.total_amount.toFixed(2)}</td>
                    <td class="p-4 whitespace-nowrap text-sm font-medium text-green-600">₹${sale.total_profit.toFixed(2)}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- 8. PAGE: REPORTS ---
        
        async function loadReports() {
            const tableBody = document.getElementById('top-selling-table');
            const loadingMsg = document.getElementById('reports-loading');
            loadingMsg.style.display = 'table-row';
            tableBody.innerHTML = '';
            
            const { data, error } = await supabase
                .from('sales_items')
                .select('item_name, quantity')
                .eq('user_id', user.id);
            
            if (error) {
                showToast('Error loading reports.', 'error');
                return;
            }
            
            if (data.length === 0) {
                loadingMsg.style.display = 'none';
                tableBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">No sales data to report.</td></tr>`;
                return;
            }
            
            // Group by item name in JS
            const productMap = new Map();
            data.forEach(item => {
                const count = productMap.get(item.item_name) || 0;
                productMap.set(item.item_name, count + item.quantity);
            });
            
            // Sort by most sold
            const sortedProducts = [...productMap.entries()].sort((a, b) => b[1] - a[1]);
            
            loadingMsg.style.display = 'none';
            sortedProducts.forEach(([name, count], index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">${index + 1}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-800">${name}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-500">${count}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // --- 9. PAGE: INVENTORY ---
        
        async function loadInventoryList() {
            const listEl = document.getElementById('inventory-list-cards');
            const loadingMsg = document.getElementById('inventory-list-loading');
            loadingMsg.style.display = 'block';
            listEl.innerHTML = '';

            const { data, error } = await supabase
                .from('inventory')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) {
                showToast('Error loading inventory.', 'error');
                return;
            }
            
            loadingMsg.style.display = 'none';
            if (data.length === 0) {
                listEl.innerHTML = `<p class="col-span-full text-gray-500">No inventory found. Go to "Add Inventory" to add a new item.</p>`;
                return;
            }
            
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg overflow-hidden flex flex-col';
                
                const placeholder = 'https://placehold.co/400x400/e2e8f0/94a3b8?text=No+Image';
                let imageUrl = placeholder;
                if (item.image_path) {
                    const { data: urlData } = supabase.storage.from(IMAGE_BUCKET).getPublicUrl(item.image_path);
                    if (urlData) imageUrl = urlData.publicUrl;
                }
                
                const profit = (parseFloat(item.price) || 0) - (parseFloat(item.cost) || 0);
                
                card.innerHTML = `
                    <img src="${imageUrl}" alt="${item.name}" class="h-56 w-full object-cover" onerror="this.src='${placeholder}'">
                    <div class="p-5 space-y-3 flex-1 flex flex-col">
                        <div class="flex items-center justify-between">
                            <h3 class="text-xl font-bold text-gray-900">${item.name}</h3>
                            <span class="rounded-full bg-green-100 px-3 py-1 text-sm font-semibold text-green-800">
                                Size: ${item.size}
                            </span>
                        </div>
                        <div class="flex-1 space-y-2">
                            <p class="text-sm text-gray-600">Stock: <span class="font-bold text-lg text-gray-800">${item.stock}</span></p>
                            <p class="text-sm text-gray-600">Cost: <span class="font-medium text-gray-800">₹${item.cost || 0}</span></p>
                            <p class="text-sm text-gray-600">Price: <span class="font-medium text-gray-800">₹${item.price || 0}</span></p>
                            <p class="text-sm text-gray-600">Profit: <span class="font-bold text-green-700">₹${profit.toFixed(2)}</span></p>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 grid grid-cols-2 gap-2">
                        <button data-id="${item.id}" class="edit-inventory-btn w-full rounded-lg bg-yellow-500 px-4 py-2 text-sm font-medium text-white hover:bg-yellow-600">Edit</button>
                        <button data-id="${item.id}" data-image-path="${item.image_path || ''}" class="delete-inventory-btn w-full rounded-lg bg-red-600 px-4 py-2 text-sm font-medium text-white hover:bg-red-700">Delete</button>
                    </div>
                `;
                listEl.appendChild(card);
            });
            
            document.querySelectorAll('.delete-inventory-btn').forEach(btn => btn.addEventListener('click', handleDeleteInventory));
            // Add listeners for 'edit' when functionality is built
        }
        
        async function handleAddInventory(e) {
            e.preventDefault();
            const form = e.target;
            const file = form['jersey-image'].files[0];
            let imagePath = null;
            
            const addBtn = document.getElementById('add-stock-btn');
            addBtn.disabled = true;
            addBtn.textContent = 'Uploading...';

            try {
                if (file) {
                    const filePath = `public/${user.id}/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await supabase.storage
                        .from(IMAGE_BUCKET)
                        .upload(filePath, file);
                    
                    if (uploadError) throw new Error(`Storage Error: ${uploadError.message}`);
                    imagePath = filePath;
                }

                const item = {
                    user_id: user.id,
                    name: form['jersey-name'].value,
                    size: form['jersey-size'].value,
                    stock: parseInt(form['jersey-stock'].value),
                    price: parseFloat(form['jersey-price'].value) || 0,
                    cost: parseFloat(form['jersey-cost'].value) || 0,
                    image_path: imagePath,
                };
            
                const { error: insertError } = await supabase.from('inventory').insert(item);
                if (insertError) throw new Error(`Database Error: ${insertError.message}`);
                
                form.reset();
                showToast('Jersey added to stock!', 'success');
                window.location.hash = 'inventory'; // Go to inventory list
            } catch (error) {
                console.error("Error adding inventory:", error);
                showToast(`Error: ${error.message}`, 'error');
                if (imagePath) {
                    await supabase.storage.from(IMAGE_BUCKET).remove([imagePath]);
                }
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add to Stock';
            }
        }
        
        async function handleDeleteInventory(e) {
            const id = e.target.dataset.id;
            const imagePath = e.target.dataset.imagePath;

            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    const { error: deleteError } = await supabase
                        .from('inventory')
                        .delete()
                        .eq('id', id);
                    if (deleteError) throw new Error(`Database Error: ${deleteError.message}`);
                    
                    if (imagePath && imagePath !== 'null' && imagePath !== '') {
                        const { error: storageError } = await supabase.storage
                            .from(IMAGE_BUCKET)
                            .remove([imagePath]);
                        if (storageError) console.warn("Could not delete image:", storageError.message);
                    }
                    showToast('Item deleted.', 'success');
                    await loadInventoryList(); // Reload this page
                } catch (error) {
                    console.error("Error deleting item:", error);
                    showToast(`Error: ${error.message}`, 'error');
                }
            }
        }
        
        // --- 10. PAGE: CUSTOMERS ---
        
        const categoryClasses = {
            high: "bg-red-100 text-red-800",
            mid: "bg-yellow-100 text-yellow-800",
            regular: "bg-blue-100 text-blue-800"
        };
        const categoryNames = {
            high: "High Class",
            mid: "Middle Class",
            regular: "Regular"
        };
        
        async function loadCustomerList() {
            const listEl = document.getElementById('customer-list-cards');
            const loadingMsg = document.getElementById('customers-loading');
            loadingMsg.style.display = 'block';
            listEl.innerHTML = '';
            
            const { data, error } = await supabase
                .from('customers')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) {
                showToast('Error loading customers.', 'error');
                return;
            }
            
            loadingMsg.style.display = 'none';
            if (data.length === 0) {
                listEl.innerHTML = `<p class="col-span-full text-gray-500">No customers found. Go to "Add Customer" to add one.</p>`;
                return;
            }
            
            data.forEach(customer => {
                const category = customer.category || 'regular';
                const categoryClass = categoryClasses[category];
                const categoryName = categoryNames[category];
                const waLink = formatWhatsAppLink(customer.contact);
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-lg flex flex-col';
                card.innerHTML = `
                    <div class="p-5 space-y-4 flex-1">
                        <div class="flex items-start justify-between">
                            <h3 class="text-xl font-bold text-gray-900">${customer.name}</h3>
                            <span class="ml-2 flex-shrink-0 rounded-full ${categoryClass} px-3 py-1 text-sm font-semibold">
                                ${categoryName}
                            </span>
                        </div>
                        <p class="text-gray-600">${customer.contact || 'No contact info'}</p>
                        
                        <div>
                             <label for="cat-select-${customer.id}" class="text-sm font-medium text-gray-700">Change Category:</label>
                             <select data-id="${customer.id}" id="cat-select-${customer.id}" class="customer-category-select mt-1 w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500 sm:text-sm">
                                <option value="regular" ${category === 'regular' ? 'selected' : ''}>Regular</option>
                                <option value="mid" ${category === 'mid' ? 'selected' : ''}>Middle Class</option>
                                <option value="high" ${category === 'high' ? 'selected' : ''}>High Class</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-px bg-gray-50 rounded-b-lg overflow-hidden">
                        <a ${waLink ? `href="${waLink}" target="_blank"` : ''} 
                           class="flex items-center justify-center gap-2 bg-white p-3 text-sm font-medium text-green-600 ${!waLink ? 'opacity-50 cursor-not-allowed' : 'hover:bg-green-50'}">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.3 20.58C8.77 21.39 10.37 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2ZM17.23 15.26C16.98 15.91 15.82 16.5 15.19 16.56C14.63 16.61 13.9 16.62 13.22 16.43C12.44 16.22 11.4 15.92 10.23 14.8C8.82 13.43 7.84 11.77 7.6 11.02C7.36 10.27 7.55 9.61 7.74 9.32C7.94 9.03 8.21 8.79 8.5 8.5C8.79 8.21 8.94 8.04 9.09 7.8C9.24 7.56 9.17 7.35 9.07 7.15C8.97 6.95 8.32 5.31 8.07 4.81C7.82 4.31 7.57 4.37 7.37 4.37C7.17 4.37 6.97 4.37 6.77 4.37C6.57 4.37 6.22 4.47 5.92 4.76C5.62 5.06 4.97 5.66 4.97 6.81C4.97 7.96 5.97 9.06 6.12 9.26C6.27 9.46 7.42 11.38 9.34 12.31C10.96 13.08 11.35 13.23 11.78 13.4C12.4 13.62 12.96 13.59 13.43 13.5C13.96 13.41 15.12 12.8 15.42 12.1C15.72 11.4 15.72 10.85 15.62 10.65C15.52 10.45 15.37 10.35 15.12 10.1C14.87 9.85 13.77 9.29 13.52 9.19C13.27 9.09 13.07 9.04 12.87 9.29C12.67 9.54 12.22 10.1 12.07 10.3C11.92 10.5 11.77 10.55 11.52 10.3C11.27 10.05 10.59 9.81 9.77 9.07C9.11 8.48 8.65 7.78 8.4 7.43C8.15 7.08 8.06 6.86 8.21 6.66C8.36 6.46 8.54 6.28 8.74 6.11C8.94 5.94 9.14 5.79 9.34 5.79C9.54 5.79 9.74 5.89 9.89 6.19C10.04 6.49 10.69 8.13 10.94 8.63C11.19 9.13 11.44 9.19 11.64 9.19C11.84 9.19 12.04 9.09 12.24 8.99C12.44 8.89 13.54 8.33 13.79 8.23C14.04 8.13 14.24 8.18 14.44 8.43C14.64 8.68 15.09 9.24 15.24 9.44C15.39 9.64 15.54 9.69 15.79 9.59C16.04 9.49 16.93 8.93 17.18 8.83C17.43 8.73 17.63 8.78 17.83 9.03C18.03 9.28 18.23 9.84 18.23 10.09C1E+23 10.34 18.23 10.59 18.18 10.69C18.13 10.79 17.48 11.35 17.23 15.26Z"></path></svg>
                            <span>Chat</span>
                        </a>
                        <button data-id="${customer.id}" class="delete-customer-btn flex items-center justify-center gap-2 bg-white p-3 text-sm font-medium text-red-600 hover:bg-red-50">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                            Delete
                        </button>
                    </div>
                `;
                listEl.appendChild(card);
            });
            
            document.querySelectorAll('.customer-category-select').forEach(sel => sel.addEventListener('change', handleCategoryChange));
            document.querySelectorAll('.delete-customer-btn').forEach(btn => btn.addEventListener('click', handleDeleteCustomer));
        }
        
        function formatWhatsAppLink(contact) {
            if (!contact) return null;
            const digits = contact.replace(/\D/g, '');
            if (digits.length === 10 && ['6','7','8','9'].includes(digits[0])) {
                return `https://wa.me/91${digits}`;
            }
            if (digits.length === 12 && digits.startsWith('91')) {
                return `https://wa.me/${digits}`;
            }
            return null;
        }

        async function handleAddCustomer(e) {
            e.preventDefault();
            const form = e.target;
            const customer = {
                user_id: user.id,
                name: form['customer-name'].value,
                contact: form['customer-contact'].value,
                category: form['customer-category'].value,
            };
            
            try {
                const { error } = await supabase.from('customers').insert(customer);
                if (error) throw error;
                form.reset();
                showToast('Customer added!', 'success');
                window.location.hash = 'customers';
            } catch (error) {
                console.error("Error adding customer:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function handleCategoryChange(e) {
            const id = e.target.dataset.id;
            const newCategory = e.target.value;
            try {
                const { error } = await supabase
                    .from('customers')
                    .update({ category: newCategory })
                    .eq('id', id);
                if (error) throw error;
                showToast('Category updated.', 'success');
                await loadCustomerList(); // Reload this page
            } catch (error) {
                console.error("Error updating category:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function handleDeleteCustomer(e) {
            const id = e.currentTarget.dataset.id;
            if (confirm('Are you sure you want to delete this customer?')) {
                try {
                    const { error } = await supabase
                        .from('customers')
                        .delete()
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Customer deleted.', 'success');
                    await loadCustomerList(); // Reload this page
                } catch (error) {
                    console.error("Error deleting customer:", error);
                    showToast(`Error: ${error.message}`, 'error');
                }
            }
        }
        
        // --- 11. PAGE: EXPENSES ---
        
        async function loadExpenses() {
            const tableBody = document.getElementById('expenses-table');
            const loadingMsg = document.getElementById('expenses-loading');
            loadingMsg.style.display = 'table-row';
            tableBody.innerHTML = '';
            
            const { data, error } = await supabase
                .from('expenses')
                .select('*')
                .eq('user_id', user.id)
                .order('created_at', { ascending: false });

            if (error) {
                showToast('Error loading expenses.', 'error');
                return;
            }
            
            loadingMsg.style.display = 'none';
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-gray-500">No expenses recorded yet.</td></tr>`;
                return;
            }
            
            data.forEach(expense => {
                const date = new Date(expense.created_at).toLocaleDateString('en-IN');
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                    <td class="p-4 whitespace-nowrap text-sm font-medium text-gray-900">${expense.description}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-gray-900">₹${expense.amount.toFixed(2)}</td>
                    <td class="p-4 whitespace-nowrap text-sm text-right">
                        <button data-id="${expense.id}" class="delete-expense-btn text-red-500 hover:text-red-700">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            
            document.querySelectorAll('.delete-expense-btn').forEach(btn => btn.addEventListener('click', handleDeleteExpense));
        }
        
        async function handleAddExpense(e) {
            e.preventDefault();
            const form = e.target;
            const expense = {
                user_id: user.id,
                description: form['expense-desc'].value,
                amount: parseFloat(form['expense-amount'].value),
            };
            
            try {
                const { error } = await supabase.from('expenses').insert(expense);
                if (error) throw error;
                form.reset();
                showToast('Expense added!', 'success');
                await loadExpenses(); // Reload this page
            } catch (error) {
                console.error("Error adding expense:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        async function handleDeleteExpense(e) {
            const id = e.currentTarget.dataset.id;
            if (confirm('Are you sure you want to delete this expense?')) {
                try {
                    const { error } = await supabase
                        .from('expenses')
                        .delete()
                        .eq('id', id);
                    if (error) throw error;
                    showToast('Expense deleted.', 'success');
                    await loadExpenses(); // Reload this page
                } catch (error) {
                    console.error("Error deleting expense:", error);
                    showToast(`Error: ${error.message}`, 'error');
                }
            }
        }

        // --- 12. PAGE: SHARE ---
        
        async function loadShareSettings() {
            const { data, error } = await supabase
                .from('settings')
                .select('*')
                .eq('user_id', user.id)
                .limit(1)
                .single();

            let whatsappUrl = 'https://wa.me/917793036608';
            let instaUrl = 'https://www.instagram.com/ommensfashion?igsh=YWtrNnlhZmoycmpp';
            let phoneNumber = '7793036608';

            if (data) {
                whatsappUrl = data.whatsapp || whatsappUrl;
                instaUrl = data.instagram || instaUrl;
                phoneNumber = data.phone || phoneNumber;
            } else if (error && error.code !== 'PGRST116') {
                console.error("Error loading settings:", error);
            }

            document.getElementById('whatsapp-url').value = whatsappUrl;
            document.getElementById('instagram-url').value = instaUrl;
            document.getElementById('phone-number').value = phoneNumber;

            // --- Generate Social QR ---
            const baseUrl = `${window.location.origin}${window.location.pathname}`.replace('admin_dashboard.html', '');
            const shareParams = new URLSearchParams();
            shareParams.set('whatsapp', whatsappUrl);
            shareParams.set('insta', instaUrl);
            shareParams.set('phone', phoneNumber);
            
            // This link format `#share/?...` is for the *old* app
            // We'll keep it for now, but a separate file is better
            const shareLink = `${baseUrl}#share/?${shareParams.toString()}`;
            document.getElementById('shareable-link').value = shareLink;
            
            const qrContainer = document.getElementById('qrcode-container');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, { text: shareLink, width: 256, height: 256 });
            
            // --- Generate Collection QR ---
            const collectionUrl = (document.getElementById('collection-link').value || 'https://vinodbhaiya.onrender.com/collection.html'); 
            const collectionQrContainer = document.getElementById('collection-qrcode-container');
            collectionQrContainer.innerHTML = '';
            new QRCode(collectionQrContainer, { text: collectionUrl, width: 256, height: 256 });
        }
        
        async function handleSaveShareLinks(e) {
            e.preventDefault();
            const links = {
                user_id: user.id,
                whatsapp: document.getElementById('whatsapp-url').value,
                instagram: document.getElementById('instagram-url').value,
                phone: document.getElementById('phone-number').value,
            };
            
            try {
                const { error } = await supabase
                    .from('settings')
                    .upsert(links, { onConflict: 'user_id' });
                if (error) throw error;

                const successMsg = document.getElementById('save-links-success');
                successMsg.style.display = 'block';
                setTimeout(() => { successMsg.style.display = 'none'; }, 3000);
                
                await loadShareSettings();
            } catch (error) {
                console.error("Error saving links:", error);
                showToast(`Error: ${error.message}`, 'error');
            }
        }
        
        function copyShareLink(inputId) {
            const linkInput = document.getElementById(inputId);
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                showToast('Link copied to clipboard!', 'success');
            } catch (err) {
                showToast('Failed to copy link.', 'error');
            }
        }

        function handlePrintQR(containerId, title) {
            const qrContainer = document.getElementById(containerId);
            const qrImage = qrContainer.querySelector('img');
            if (!qrImage) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print QR Code</title>');
            printWindow.document.write('<style>body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; text-align: center; margin-top: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; } img { width: 300px; height: 300px; margin-top: 20px; } h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 0; } p { font-size: 1.25rem; color: #4A5568; margin-top: 10px; }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(`<h1>Ommen's Fashion</h1>`);
            printWindow.document.write(`<p>Scan for our ${title}</p>`);
            printWindow.document.write('<img src="' + qrImage.src + '">');
            printWindow.document.write('</body></html>');
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        // --- 13. UTILITIES ---
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            if (type === 'success') {
                toast.className = 'fixed bottom-10 right-10 z-50 transform rounded-lg px-5 py-3 text-white shadow-lg bg-green-600';
            } else {
                toast.className = 'fixed bottom-10 right-10 z-50 transform rounded-lg px-5 py-3 text-white shadow-lg bg-red-700';
            }
            
            toast.style.display = 'block';
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => { toast.style.display = 'none'; }, 500);
            }, 3000);
        }

        // --- 14. INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', handleRouting);
        window.addEventListener('resize', handleRouting); // Check for mobile
    </script>
</body>
</html>
